name: Update Protocol Documentation

on:
  push:
    paths:
      - 'protocol/**'
      - 'frontend/scripts/generate-protocol-docs.js'
      - 'frontend/package.json'
  pull_request:
    paths:
      - 'protocol/**'
      - 'frontend/scripts/generate-protocol-docs.js'

jobs:
  update-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    name: Update Protocol Documentation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Generate protocol documentation
        run: cd frontend && npm run build:protocol-docs

      - name: Check for changes
        id: verify-changed-files
        run: |
          # Check if there are any changes to source files that would affect docs
          if [ -n "$(git status --porcelain protocol/ frontend/scripts/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Source files have been updated - docs may need regeneration"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No source changes detected"
          fi

  notify-pr:
    runs-on: ubuntu-latest
    needs: update-docs
    if: github.event_name == 'pull_request' && needs.update-docs.result == 'success'
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const docsUpdated = '${{ needs.update-docs.outputs.changed }}';

            if (docsUpdated === 'true') {
              const message = `## ðŸ“š Protocol Documentation Status

              The protocol documentation generator has been run and is ready to display updated information based on the changes to the \`protocol/\` directory:

              - âœ… Protocol overview with current statistics
              - âœ… Implementation guide reflecting latest modules
              - âœ… Tool reference with all available utilities
              - âœ… Schema documentation updated

              The website will automatically display the latest protocol information once these changes are merged.

              **Documentation will be generated:**
              - Fresh documentation created during build process
              - Available at [Documentation page](https://refuse-protocol.org/docs) after merge
              - All protocol changes are reflected automatically`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '## ðŸ“š Protocol Documentation Status\n\nNo documentation updates were needed for these protocol changes. The existing documentation is already current.'
              });
            }
